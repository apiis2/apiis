#!/usr/bin/env perl 
use warnings;
##############################################################################
# $Id: file2inspool.pl,v 1.32 2005/05/09 12:20:04 duchev Exp $
# Load the incoming data streams from the inspool directory into the
# corresponding table 'inspool' and do some recordings in table
# 'load_stat'.
##############################################################################
BEGIN {
   use Env qw( APIIS_HOME );
   die "\n\tAPIIS_HOME is not set!\n\n" unless $APIIS_HOME;
   push @INC, "$APIIS_HOME/lib";
}

use strict;
use warnings;
use Apiis;
Apiis->initialize( VERSION => '$Revision: 1.32 $' );

use vars qw/$opt_m $opt_f $opt_h/;
use File::Copy;
use Getopt::Std;
use apiis_alib;

getopts('hf:m:');
die usage() if $opt_h;
die usage() unless $opt_m;
my $model_file=$opt_m if $opt_m;
$apiis->join_model($model_file); 
$apiis->check_status;

my $inspool_dir = $apiis->APIIS_LOCAL."/load/inspool";
$inspool_dir=$opt_f if $opt_f;

file2inspool($inspool_dir);

sub usage {
my $programname = 'file2inspool';
die __("usage"), ':', " " x length($programname), "\n",
   $programname,               " -h\t  --> ",  __("Help"), "\n",
 " " x length($programname), " -f  <", __("Folder name"),">\t --> ", ___("Folder name"), "\n",
   " " x length($programname), " -m  <",__("Name of the model file"),">\t --> ",__("Name of the model file"), "\n";
}

######################################################################
# some documentation:

=head1  file2inspool.pl 

The program is looking for  files in directory "$APIIS_LOCAL/load/inspool",
reads the data and loads them into the INSPOOL table in your database.
Files in the inspool directory have to be text files containing one record
per line.

Each filename in your inspool directory has to start with DSxx where xx is
the number of the data stream (DS01, DS02, ...)

After running the program, each row of the INSPOOL table contains the data
stream identification (DS01, DS02...) in column ds, a unique number
generated by sequence 'seq_inspool__in_id' (column in_id), the status
(NEW), the time of processing (timestamp) and the whole, unchanged record
in ASCII format (column record).    

The table LOAD_STAT is populated with a new record about the insertion of
the new datastream into INSPOOL.
The filename of the loaded data is stored in column JOB, the start and end
of this job are recorded in the appropriate columns, also the total number
of inserted records (nrec_tot).

After successful loading the datafile is moved to "$APIIS_LOCAL/load/inspool/done".

If the datastream contains BLOBS (binary large objects) - pictures, movies etc. then the new special table "blobs" is used. In the datastream on the third row - the word "blobs" should occure followed by the number of elements in a row and position number of the file names in the data rows.
For example:

DS01

ini

blobs 5 1 3 

cat|/home/zgr/duchev/pictures/IN00006A.JPG|123.56|IN00009A.JPG|jpg

dog|IN00004A.JPG|87.10|/home/zgr/duchev/pictures/IN00005A.JPG|jpg

All files from one datastream should be stored in separate subfolder of the "inspool" folder. The "file2inspool.pl" should be invoked in the following manner:

file2inspool.pl -f <folder name> -m <model_file>

The script reads DS file from this folder, loads files into BLOBS table, stores the returned record identifiers insted of the file names in the DS file and load these records as usual in the INSPOOL table.

=cut 
##############################################################################    
